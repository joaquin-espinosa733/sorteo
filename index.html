<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sorteos Sute</title>
    <link rel="icon" type="image/png" href="./assets/favicon.ico" />
    <!-- ðŸ‘‡ Importamos Sansita y Poppins desde Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Sansita:wght@400;700;800&family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <h1>Sorteo SUTE ðŸŽ‰</h1>

    <input type="file" id="archivo" accept=".txt" />
    <br />
    <label for="cantidad">Cantidad de ganadores a sortear:</label>
    <input type="number" id="cantidad" min="1" value="1" />
    <br />
    <div class="botones">
      <button id="botonSortear" onclick="sortear()">Sortear</button>
      <button onclick="reiniciar()">Reiniciar ganadores</button>
      <button onclick="descargarGanadores()">Descargar ganadores</button>
    </div>

    <div id="contador">Ganadores hasta ahora: 0</div>
    <div id="cuenta-regresiva"></div>
    <div id="ganadores"></div>

    <script>
      let lista = [];
      let ganadores = JSON.parse(localStorage.getItem("ganadores")) || [];

      document
        .getElementById("archivo")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (e) {
            lista = e.target.result
              .split("\n")
              .map((x) => x.trim())
              .filter((x) => x.length > 0);
            lista = lista.filter((item) => !ganadores.includes(item));
            alert(
              "Archivo cargado correctamente. Total participantes: " +
                lista.length
            );
          };
          reader.readAsText(file);
        });

      function sortear() {
        const cantidad = parseInt(document.getElementById("cantidad").value);
        const btn = document.getElementById("botonSortear");
        const countdownDiv = document.getElementById("cuenta-regresiva");

        if (isNaN(cantidad) || cantidad <= 0) {
          alert("Por favor, ingresa una cantidad vÃ¡lida.");
          return;
        }

        if (lista.length < cantidad) {
          alert("No hay suficientes participantes disponibles.");
          return;
        }

        let segundos = 5;
        countdownDiv.textContent = segundos;
        btn.disabled = true;

        const interval = setInterval(() => {
          segundos--;
          countdownDiv.textContent = segundos > 0 ? segundos : "";

          if (segundos === 0) {
            clearInterval(interval);
            ejecutarSorteo(cantidad);
            btn.disabled = false;
          }
        }, 1000);
      }

      function ejecutarSorteo(cantidad) {
        let nuevosGanadores = [];

        for (let i = 0; i < cantidad; i++) {
          const indice = Math.floor(Math.random() * lista.length);
          const ganador = lista.splice(indice, 1)[0];
          nuevosGanadores.push(ganador);
          ganadores.push(ganador);
        }

        localStorage.setItem("ganadores", JSON.stringify(ganadores));

        mostrarGanadores(nuevosGanadores);
        actualizarContador();
      }

      function mostrarGanadores(listaGanadores) {
        const div = document.getElementById("ganadores");
        div.innerHTML =
          "<h3>Ganadores sorteados:</h3><ul>" +
          listaGanadores.map((g) => `<li>${g}</li>`).join("") +
          "</ul>";

        const ul = div.querySelector("ul");
        if (ganadores.length > 10) {
          ul.classList.add("dos-columnas");
        } else {
          ul.classList.remove("dos-columnas");
        }
      }

      function actualizarContador() {
        document.getElementById(
          "contador"
        ).textContent = `Ganadores hasta ahora: ${ganadores.length}`;
      }

      function reiniciar() {
        if (confirm("Â¿EstÃ¡s seguro de reiniciar los ganadores?")) {
          localStorage.removeItem("ganadores");
          ganadores = [];
          actualizarContador();
          alert("Ganadores reiniciados.");
        }
      }

      // ðŸ‘‡ Nueva funciÃ³n: descargar TXT con ganadores
      function descargarGanadores() {
        if (ganadores.length === 0) {
          alert("No hay ganadores para descargar.");
          return;
        }

        const contenido = ganadores.join("\n");
        const blob = new Blob([contenido], { type: "text/plain" });
        const enlace = document.createElement("a");
        enlace.href = URL.createObjectURL(blob);
        enlace.download = "ganadores.txt";
        enlace.click();
        URL.revokeObjectURL(enlace.href);
      }

      actualizarContador();
    </script>
  </body>
</html>
